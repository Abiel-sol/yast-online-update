@HEADER-COMMENT@

@HEADER@
BuildRequires:	gcc-c++ libxcrypt-devel perl-XML-Writer update-desktop-files pkg-config yast2-devtools yast2-packager yast2-bootloader
PreReq:		grep sed
# script callbacks
Requires:	yast2 yast2-pkg-bindings >= 2.13.99
# PackageCallbacks::FormatPatchName
Requires:	yast2-packager >= 2.13.159

Provides:	y2c_online_update yast2-config-online-update
Obsoletes:	y2c_online_update yast2-config-online-update
Provides:	yast2-trans-online-update y2t_online_update
Obsoletes:	yast2-trans-online-update y2t_online_update
BuildArchitectures:     noarch

Summary:    	YaST2 online update

%description
-

@PREP@

@BUILD@

@INSTALL@
mkdir -p "$RPM_BUILD_ROOT"@vardir@
cp $RPM_BUILD_ROOT/usr/share/applications/YaST2/cd_update.desktop $RPM_BUILD_ROOT/var/lib/YaST2/cd_update.desktop

@CLEAN@

%post
if [ -f /etc/cron.d/yast2-online-update ] ; then
    cronjob=`grep "rug up -t patch" /etc/cron.d/yast2-online-update 2>/dev/null | grep -v "\-y"`
    if [ -n "$cronjob"  ] ; then
	# do not ask for confirmation
	sed -e "s/rug up/rug up -y/" -i /etc/cron.d/yast2-online-update
    fi
    cronjob=`grep "online_update" /etc/cron.d/yast2-online-update 2>/dev/null`
    if [ -n "$cronjob"  ] ; then
	sed -e "s/online_update/rug up -y -t patch/" -i /etc/cron.d/yast2-online-update
	if [ "`echo "$cronjob" | grep -c " -g" 2>/dev/null`" -gt 0 ] ; then
	    sed -e "s/ -g/ -d/" -i /etc/cron.d/yast2-online-update
	fi
	if [ "`echo "$cronjob" | grep -c " -P" 2>/dev/null`" -gt 0 ] ; then
	    sed -e "s/ -P/ --skip-interactive/" -i /etc/cron.d/yast2-online-update
	fi
    fi
    rm -f /etc/cron.d/yast2-online-update.bak
    # now we have zypper instead of rug (bug #273133)
    if [ "`grep -c rug /etc/cron.d/yast2-online-update 2>/dev/null`" -gt 0 ]; then
    	sed -e "s/rug/zypper/g" -i /etc/cron.d/yast2-online-update
    fi
    # -d is not supported in 10.3
    sed -e "s/ -d//" -i /etc/cron.d/yast2-online-update
fi
to_remove="/usr/share/YaST2/clients/product_post.ycp"
if [ -f $to_remove ] ; then
    eval "echo '2ee660f33bb8468654661bcf2a564fd4  $to_remove' | md5sum --status -c 2>/dev/null"
    if [ "$?" == 0 ] ; then
	rm -f $to_remove
    fi
fi

%files
%defattr(-,root,root)
@desktopdir@/online_update_setup.desktop
@schemadir@/autoyast/rnc/online_update.rnc
@scrconfdir@/*.scr
@clientdir@/online*.ycp
@clientdir@/cd_update.ycp
@clientdir@/inst_you.ycp
@moduledir@/OnlineUpdate*.ycp
@moduledir@/OnlineUpdate*.ybc
@moduledir@/AutoOnlineUpdate*.ycp
@moduledir@/AutoOnlineUpdate*.ybc
%doc @docdir@

%package frontend
Summary:	Desktop files for YaST2 online update
Requires:	yast2-online-update
Group:          System/YaST

%description frontend
-

%post frontend
if test "`uname -i`" = "s390" -o "`uname -i`" = "s390x"; then
    # remove the.desktop from the older unhacked package during update
    rm -f /usr/share/applications/YaST2/cd_update.desktop
else
    cp /var/lib/YaST2/cd_update.desktop /usr/share/applications/YaST2/
fi

%files frontend
%defattr(-,root,root)
@desktopdir@/online_update.desktop
@vardir@/cd_update.desktop
%ghost @desktopdir@/cd_update.desktop
